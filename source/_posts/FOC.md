---
title: FOC
date: 2025-02-05 00:49:24
tags: [MCU,FOC]
index_img: /img/avatar.png
---

# FOC

实现效果				

<iframe
   width="800"
   height="450"
   src='e1be5e4e059862398241510a987e935f.mp4'
   frameborder="0"
   allowfullscreen>
</iframe>



#### 1.配置定时器输出三路PWM

（这个方案基于驱动IC，驱动IC接收MCU3路PWM输入，转换成3对互补PWM输出，用于驱动三相桥的6个mosfet，并且驱动IC可以自动插入死区时间，如果选择不用驱动IC的方案则需手动配置6路互补PWM并且要考虑死区插入等一系列问题）

注意pwm的三个参数：频率，分辨率，占空比

#### 2.使电机转到固定电角度

通过park反变换和clark反变换最终实现输入电角度和电压，输出合适的三相pwm

#### 3.开环速度

根据时间生成一个逐渐增大的电角度并调用相关函数即可让电机持续转动  

这里要配置定时器并开启定时器中断

最终实现输入速度，只要让电角度按固定步长增长，就能实现电机开环控制，固定步长的计算为循环运行时间间隔*目标速度（需要注意单位一致）

#### 4.AS5600获取角度

通过软件I2C与传感器通信

#### 5.电角度对齐

将AS5600和电角度的量程尺度化为一致

#### 6.闭环位置

#### 7.AS5600获取速度（注意方向问题）

传感器接收两次角度的差/间隔时间=角速度

#### 8.闭环速度

引入pid算法，输入期望速度，计算需要的合适的q轴电压值，然后调用函数生成pwm波控制

#### 9.闭环位置

#### 10.获取Iq电流

配置ADC+DMA用于读取采样电阻阻值（滤波），根据阻值算出电流

#### 11.Iq电流闭环

输入期望速度，计算需要的合适的q轴电流值

#### 12.双闭环或者三闭环

核心思想就是位置PID输出给速度环PID,速度环输出给电流环PID，在这个过程中可以限定输出范
围，如0.1A、速度。即限定力矩。  

#### 13.CAN通信

硬件加入can收发器，软件加入can通信



