---
title: 典中典之最容易被遗忘的ADC原理
date: 2025-10-23 09:37:24
tags: [MCU]
index_img: /img/avatar.png

---

# 典中典之最容易被遗忘的ADC原理

## 前言

之前打RM的时候很少用到ADC，因为赛场上ADC没有什么复杂的应用场景，导致我之前对ADC的理解一直停留在了一个很浅的层面。最近实习有个需求需要用到单路ADC多通道采集的功能，就趁此机会好好研究了一下MCU中的ADC，以及尝试一下找出不同应用场景下使用ADC的最优解。

## ADC原理

在我心目中，ADC应该是最经典的生产者之一，所以要想实现整条生产-消费链路的高效化，生产时间无疑是其中非常重要的一环。这就要求我们得了解ADC是如何从模拟信号输入到数字信号输出的整个流程。

##### 1.扛混叠滤波

这个其实是在MCU外部进行处理的，由模拟电路物理上滤除模拟信号中高于奈奎斯特频率的高频成分，通常是一个简单的RC低通滤波器。

由于这个不是影响ADC生产时间的重要因素，作为软件开发，了解一下即可。

##### 2.采样与保持

- **采样**：按固定的时间间隔，快速“抓取”模拟信号的瞬时值。这好比在生产线上，以极高的速度对连续流动的原料进行瞬时拍照，记录下某一刻的状态。
- **保持**：采样结束后，需要立即将这个瞬时电压值“冻结”住，并保持一段时间。这就为后续的精细加工（量化和编码）提供了稳定的工作条件。通常由采样保持电路实现，其核心是一个电容，采样时充电以记录电压，保持阶段则维持该电压。

根据奈奎斯特采样定理，采样频率必须至少是输入信号最高频率分量的两倍，才能无失真地还原原始信号。在实际应用中，为了更好保留细节，通常会选择信号最高频率的5到10倍甚至更高作为采样频率。

##### 3.量化与编码

这里直接把量化和编码过程合称为转换过程。ADC的分辨率（位数，n）越高，量化等级（2^n）就越多，每个等级所代表的电压范围（LSB，最低有效位）就越小，量化误差也就越小，测量结果越精确。

转换过程花费的时间主要取决于ADC的架构，逐次逼近型ADC转化时间固定为N个时钟周期，Σ-Δ型ADC转换时间则较长，这个马上就详细讲讲。

## 主流的ADC架构

目前直到我写这篇博客的时候，STM32除了L0和L1没有使用SAR ADC，其他系列都是SAR ADC，所以主要只需了解逐次逼近型ADC的架构就行。

##### 1. 逐次逼近型ADC（SAR ADC）

- **工作原理**：采用一种“二分搜索”或“天平称重”的策略。从最高位（MSB）开始，逐位试探性地置1，并通过内部的数模转换器（DAC）产生对应的模拟电压，与输入电压进行比较。根据比较结果决定该位最终是1还是0，直至最低位（LSB）。
- **特点**：在速度、精度和功耗之间取得了很好的平衡。**转换时间是固定的，需要N个时钟周期完成N位转换。**
- **应用**：非常广泛，常见于微控制器的内置ADC中，适用于中速数据采集系统、传感器接口、工业控制等。

##### 2. Σ-Δ型ADC

- **工作原理**：采用“过采样”和“噪声整形”技术。它以远高于奈奎斯特频率的速率对信号进行采样（过采样），并将量化噪声“驱赶”到高频区域，然后通过数字滤波器滤除这些高频噪声，从而在有效信号带宽内获得极高的信噪比和分辨率。
- **特点**：能够实现极高的分辨率（可达16-24位甚至更高），但转换速度通常较慢。
- **应用**：高精度测量领域，如音频采集与处理、高精度传感器（电子秤、压力传感器）信号调理、地震监测仪器等。

##### 3. 流水线型ADC

- **工作原理**：将整个转换任务分解为多个阶段（级），每一级同时处理前一次采样留下的“残差”，并将自己的结果传递给下一级。这种流水线作业方式使得它能够并行处理多个采样数据，从而实现很高的吞吐率。
- **特点**：兼具高速度和中高分辨率。但电路复杂，通常会有较大的初始延迟（延迟）。
- **应用**：通信系统（如基站）、数字视频处理、医疗成像（如超声设备）、高速数据采集卡等需要高速处理的场景。

##### 4. 闪存型ADC

- **工作原理**：采用“并行处理”策略，使用大量的比较器（2^N - 1个）同时将输入电压与一系列参考电压进行比较，并通过一个优先级编码器直接输出对应的数字码。
- **特点**：**速度极快**，是转换速度最快的ADC架构，但功耗和芯片面积随分辨率指数级增长，因此分辨率通常较低（一般不超过8位）。
- **应用**：超高速信号处理领域，如雷达信号接收、高速示波器、光纤通信等。

## 回归实践使用

上面说了这么多，其实需要关注的只有采样时间和转换时间。转换时间跟分辨率，也就是ADC的位数有关，12位ADC对应的总时间就是
$$
ADC生产时间=采样时间+保持时间+转换时间=采样时间+0.5周期的采样保持+12周期的逐次逼近比较=采样时间+12.5ADC时钟周期
$$
采样时间，其实就是ADC内部采样保持电容对输入电压进行充电的时间。采样时间越长，电容充电越充分，测量结果越精确，但相应的转换速度会变慢。

| 考虑因素       | 采样时间           | 理由                                            |
| -------------- | ------------------ | ----------------------------------------------- |
| 信号源高阻抗   | 55周期及以上       | 信号源驱动能力弱，需要更长的充电时间            |
| 要求高精度     | 55周期及以上       | 更长的充电时间能确保电容电压稳定后才采样        |
| 要求高采样率   | 1.5，7.5，13.5周期 | 这个不用多说                                    |
| 输入信号频率高 | 1.5，7.5周期       | 为了满足奈奎斯特采样定理，需要更快的ADC整体速度 |

以我现在的工程举例，根据STM32G0x1用户手册，ADCCLK最大16Mhz，对应一个时钟周期为0.0625us，使用了ADC1的5个通道并且这5个通道采样周期都配置为7.5个时钟周期，用了扫描模式+连续转换模式+DMA循环+一轮扫描后转换的配置，则
$$
ADC生产时间=（12.5+7.5*5）*0.0625us=3.125us
$$
也就是说ADC外设在开启DMA的情况下只需3.125us。

知道这个之后玩法就有很多了，比如可以配置DMA缓冲区为

```
uint16_t adcBuffer[通道数*N];  //采集N组数据而非1组用于滤波算法
```

这样也能有效地防止一个问题，ADC生产速度过快导致就算开启了DMA，CPU还是一直被ADC转换完成中断抢占的情况。

## 
